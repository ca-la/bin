#!/bin/bash

set -o errexit
set -o nounset
set -o pipefail
set -o noglob

# Run the test suite
# Usage: bin/test

run() {
  source bin/lib/loadenv

  local ci=${CI:-"false"}

  if [ "$ci" != "true" ]; then
    loadenv_test
  fi

  reporter_opts="--pessimistic"

  while getopts "v" opt; do
    case $opt in
      v)
        reporter_opts=""
        ;;
      *)
        echo 'Usage: bin/test [-v]'
        echo 'Options:'
        echo ' -v Test reporter prints successful tests'
        exit 1
        ;;
    esac
  done

  if [ "$ci" == "true" ]; then
    mkdir -p ./reports
    npx tape -r ./dist/test-helpers/setup.js "dist/**/*spec.js" | tee >(npx tap-xunit > ./reports/tape.xml)
  else
    node -r ts-node/register --preserve-symlinks $(npm bin)/tape -r ./src/test-helpers/setup.ts "src/**/*spec.[jt]s" | npx tap-difflet $reporter_opts
  fi
}

run "$@"
