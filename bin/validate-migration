#!/bin/bash

set -euo pipefail

c_green=$'\033[0;32m'
c_red=$'\033[0;31m'
c_yellow=$'\033[1;33m'
c_reset=$'\033[0m'

before_migration_path=$TMPDIR/cala-db-before-migration.txt
after_migration_path=$TMPDIR/cala-db-after-migration.txt
after_rollback_path=$TMPDIR/cala-db-after-rollback.txt

db_url='cala-test'

pre() {
  echo -n "$@"
}

post() {
  echo $c_green Done$c_reset
}

restore_schema() {
  psql $db_url < $before_migration_path > /dev/null
}

fail_elegantly() {
  echo -n $c_red"Unable to complete migration. Restoring initial schema..."$c_reset
  restore_schema
  post
  exit 1
}

main() {
  pre 'Dumping initial schema... '
  pg_dump -csOx $db_url > $before_migration_path
  post

  pre 'Migrating... '
  DATABASE_URL=$db_url $(npm bin)/knex migrate:latest > /dev/null || fail_elegantly
  post

  pre 'Dumping migrated schema... '
  pg_dump -csOx $db_url > $after_migration_path
  post

  pre 'Rolling back... '
  DATABASE_URL=$db_url $(npm bin)/knex migrate:rollback > /dev/null || fail_elegantly
  post

  pre 'Dumping final schema... '
  pg_dump -csOx $db_url > $after_rollback_path
  post

  pre 'Restoring intial schema... '
  restore_schema
  post

  echo $c_yellow'Schema difference after migration (should be non-zero):'$c_reset
  diff $before_migration_path $after_migration_path || true

  echo $c_yellow'Schema difference after applying and rolling back (should be zero):'$c_reset
  diff $before_migration_path $after_rollback_path
}

main "$@"
