#!/bin/bash

set -o errexit
set -o nounset
set -o pipefail
set -o noglob

# Run all checks that CI needs to pass a build
# Usage: bin/ci_check

run() {
  source bin/lib/clean
  source bin/lib/build

  bin/format -al
  bin/lint

  clean
  build

  SKIP_BUILD=true bin/migrate local && bin/migrate local rollback && bin/migrate local

  npx tsc --noEmit
  npx tsc --noEmit -p src/published-types/tsconfig.json

  bin/test
}

run "$@"
