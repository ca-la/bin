#!/bin/bash
set -e

if [[ $(git rev-parse --abbrev-ref HEAD) != "master" ]] ; then
  echo 'Cannot run stg/prod migrations from a branch other than master'
  exit 1
fi

if [[ "$1" != "--force" ]]; then
  echo "Are you sure you want to migrate the STAGING db? Has your migration-only pull request been merged?"
  echo -n "Type STAGING if you're sure: "
  read RES

  if [ "$RES" != "STAGING" ]; then
    echo "OK, not migrating"
    exit 1
  fi
fi

DATABASE_URL=$(heroku config:get DATABASE_URL --app cala-api-stg)?ssl=true $(npm bin)/knex migrate:latest
